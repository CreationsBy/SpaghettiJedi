<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endless Destiny</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --text-color: #e0e0e0;
            --accent-color: #4db8ff;
            --btn-bg: #e94560;
            --btn-hover: #ff2e63;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 15px;
            --input-bg: #0f3460;
        }

        /* THEMES */
        body.theme-fantasy { --bg-color: #2c241b; --container-bg: #f4e4bc; --text-color: #4a3b2a; --accent-color: #8b4513; --btn-bg: #800000; --btn-hover: #a52a2a; --font-main: 'Georgia', serif; --border-radius: 2px; --input-bg: #e8dcb5; }
        body.theme-scifi { --bg-color: #000000; --container-bg: #0d0d0d; --text-color: #00ff41; --accent-color: #00ff41; --btn-bg: #003b00; --btn-hover: #008f11; --font-main: 'Courier New', Courier, monospace; --border-radius: 0px; --input-bg: #1a1a1a; }
        body.theme-horror { --bg-color: #0a0a0a; --container-bg: #1a0505; --text-color: #d1d1d1; --accent-color: #ff0000; --btn-bg: #520000; --btn-hover: #7a0000; --font-main: 'Times New Roman', serif; --border-radius: 5px; --input-bg: #2b0e0e; }
        body.theme-retro { --bg-color: #000084; --container-bg: #aaaaaa; --text-color: #000000; --accent-color: #000000; --btn-bg: #ffffff; --btn-hover: #cccccc; --font-main: 'Courier New', monospace; --border-radius: 0; --input-bg: #ffffff; }

        /* LAYOUT */
        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
            transition: background-color 0.5s ease;
        }

        #game-container { 
            width: 100%; 
            max-width: 800px; 
            background-color: var(--container-bg); 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
            border: 2px solid var(--accent-color); 
            position: relative; 
            display: block;
        }

        h1 { text-align: center; color: var(--accent-color); }
        
        #story-display { background-color: var(--input-bg); padding: 20px; border-radius: 5px; margin-bottom: 20px; min-height: 150px; line-height: 1.6; white-space: pre-wrap; border-left: 4px solid var(--accent-color); }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-section { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        input[type="text"] { padding: 15px; border-radius: 5px; border: 1px solid var(--accent-color); background: var(--input-bg); color: var(--text-color); font-size: 16px; font-family: var(--font-main); }
        input[type="text"]::placeholder { color: var(--text-color); opacity: 0.5; }
        
        button { padding: 12px 20px; cursor: pointer; background-color: var(--btn-bg); border: 1px solid var(--accent-color); color: white; border-radius: 5px; font-size: 16px; font-family: var(--font-main); transition: background 0.3s; }
        
        /* THEME FIXES */
        body.theme-fantasy button { color: #fff; }
        body.theme-retro button { color: #000; } 
        
        /* RETRO THEME FIX (Force High Contrast) */
        body.theme-retro .choice-btn { 
            background-color: #000000 !important; /* Force Black BG */
            color: #ffffff !important;           /* Force White Text */
            border: 1px solid #ffffff !important; 
        }
        body.theme-retro .choice-btn:hover {
            background-color: #ffffff !important; /* Force White BG on Hover */
            color: #000000 !important;           /* Force Black Text on Hover */
            border: 1px solid #000000 !important;
            filter: none !important;             /* Remove brightness filter */
        }

        button:hover { background-color: var(--btn-hover); }
        button:disabled { background-color: #555; cursor: not-allowed; }

        #choices-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .choice-btn { background-color: var(--accent-color); color: var(--bg-color); text-align: left; font-weight: bold; }
        .choice-btn:hover { filter: brightness(1.2); }

        #loading { text-align: center; display: none; color: var(--accent-color); font-style: italic; margin-top: 10px; }
        .hidden { display: none !important; }
        .row { display: flex; gap: 10px; }

        /* Progress Bar */
        #init-progress { margin-top: 10px; color: #aaa; font-size: 0.9em; text-align: center; white-space: pre-wrap;}

        /* Instructions Modal */
        #instructions-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--container-bg); padding: 30px; border-radius: 10px;
            max-width: 500px; border: 2px solid var(--accent-color); text-align: center;
        }
        .modal-content h2 { color: var(--accent-color); margin-top: 0; }
        .modal-content ul { text-align: left; margin-bottom: 20px; }
        .modal-content li { margin-bottom: 15px; line-height: 1.4; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 1; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; border: 1px solid var(--accent-color); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div id="game-container">
    <h1 id="game-title">Endless Destiny</h1>
    
    <div id="start-screen" class="input-section">
        <p>Enter any scenario (e.g., "I am a toaster," "I fight a dragon"):</p>
        <input type="text" id="start-input" placeholder="Your destiny begins here...">
        
        <div class="row" style="margin-top: 10px;">
            <button id="start-btn" style="flex: 2;">Begin Story</button>
            <button id="load-btn" style="flex: 1; background-color: #4CAF50;" class="hidden">Continue Saved Game</button>
        </div>
        <button id="howto-btn" style="background-color: #555; margin-top: 10px;">How to Play</button>
        
        <div id="init-progress"></div>
    </div>

    <div id="game-screen" class="hidden">
        <div id="story-display"></div>
        <div id="choices-container"></div>
        
        <div id="controls-section" class="input-section">
            <p>Type your own action:</p>
            <input type="text" id="custom-action-input" placeholder="Do anything you want...">
            <button id="custom-action-btn">Submit Action</button>
            
            <div class="row">
                <button id="save-btn" style="background-color: #2196F3; flex: 1;">Save (Ctrl+S)</button>
                <button id="end-game-btn" style="background-color: #555; flex: 1;">End Game</button>
            </div>
        </div>
    </div>

    <div id="loading">AI is thinking...</div>
</div>
<div id="toast">Game Saved Successfully!</div>

<div id="instructions-modal" class="hidden">
    <div class="modal-content">
        <h2>How to Play</h2>
        <ul>
            <li><strong>Start:</strong> Enter ANY scenario in the text box (e.g., "I am a wizard in space").</li>
            <li><strong>Play:</strong> The AI will write a story. You choose what happens next by clicking buttons.</li>
            <li><strong>Freedom:</strong> Don't like the options? Type ANYTHING you want in the "Type your own action" box!</li>
            <li id="save-instruction"><strong>Save:</strong> Click Save or press Ctrl+S to save your progress.</li>
        </ul>
        <button id="close-howto-btn">Got it!</button>
    </div>
</div>

<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    let engine = null;
    let engineLoaded = false;
    // SINGLE MODEL - Llama 3B
    let selectedModelId = "Llama-3.2-3B-Instruct-q4f16_1-MLC"; 

    // --- GAME STATE ---
    let originalScenario = "";
    let conversationHistory = []; 
    let currentTheme = "modern"; 
    let currentUIState = { story: "", options: [] }; 
    let previousOptions = []; // To track repetition

    // --- INITIALIZATION ---
    window.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('start-btn');
        const loadBtn = document.getElementById('load-btn');
        const saveBtn = document.getElementById('save-btn');
        const endBtn = document.getElementById('end-game-btn');
        const customBtn = document.getElementById('custom-action-btn');
        const howtoBtn = document.getElementById('howto-btn');
        const closeHowtoBtn = document.getElementById('close-howto-btn');
        const modal = document.getElementById('instructions-modal');

        // --- PLATFORM DETECTION ---
        const isMac = navigator.userAgent.toLowerCase().includes('mac');
        if (saveBtn) saveBtn.innerText = isMac ? "Save (Cmd+S)" : "Save (Ctrl+S)";
        
        const saveInstruction = document.getElementById('save-instruction');
        if (saveInstruction) {
             saveInstruction.innerHTML = isMac 
                ? "<strong>Save:</strong> Click Save or press <strong>Cmd+S</strong> to save your progress." 
                : "<strong>Save:</strong> Click Save or press <strong>Ctrl+S</strong> to save your progress.";
        }

        if(startBtn) startBtn.addEventListener('click', startGame);
        if(loadBtn) loadBtn.addEventListener('click', loadGame);
        if(saveBtn) saveBtn.addEventListener('click', saveGame);
        if(endBtn) endBtn.addEventListener('click', endGame);
        
        if(howtoBtn) howtoBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        if(closeHowtoBtn) closeHowtoBtn.addEventListener('click', () => modal.classList.add('hidden'));

        if(customBtn) {
            customBtn.addEventListener('click', () => {
                const actionText = document.getElementById('custom-action-input').value.trim();
                if (!actionText) { alert("Please type an action!"); return; }
                handleCustomAction(actionText);
            });
        }

        if (localStorage.getItem('geminiGameSave')) {
            document.getElementById('load-btn').classList.remove('hidden');
        }

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault(); 
                if (!document.getElementById('game-screen').classList.contains('hidden')) saveGame();
            }
        });
    });

    // --- LOCAL AI ENGINE LOADER ---
    async function initEngine() {
        if (engineLoaded) return;
        
        const progressLabel = document.getElementById('init-progress');
        progressLabel.innerText = "Initializing AI Brain... (May freeze briefly)";
        toggleLoading(true);

        await new Promise(r => setTimeout(r, 50));

        try {
            engine = await CreateMLCEngine(
                selectedModelId,
                { 
                    initProgressCallback: (report) => {
                        progressLabel.innerText = report.text;
                    }
                }
            );
            engineLoaded = true;
            progressLabel.innerText = "AI Ready!";
        } catch (err) {
            alert("Error loading AI: " + err.message + "\n\nYour GPU might not support Llama 3B.");
            toggleLoading(false);
            throw err;
        }
    }

    // --- ROBUST RESPONSE HANDLER ---
    async function getLocalResponse(systemContext, userPrompt, attempt = 1) {
        if (!engineLoaded) await initEngine();

        let fullSystemPrompt = systemContext + 
            "\n\nIMPORTANT: Return valid JSON only. USE SINGLE QUOTES (') for dialogue. Keep story concise.";

        // --- CONTEXT INJECTION & ANTI-REPETITION ---
        let refinedUserPrompt = userPrompt;
        
        // Standard Context Injection for better continuity
        if (conversationHistory.length > 0) {
            try {
                const lastMsg = conversationHistory[conversationHistory.length - 1];
                if (lastMsg.role === "assistant") {
                    const lastJson = JSON.parse(lastMsg.content);
                    const lastStoryText = lastJson.story_text.substring(0, 500); 
                    refinedUserPrompt = `[PREVIOUS SCENE: "${lastStoryText}..."] \n\n ${userPrompt}`;
                }
            } catch(e) {}
        }

        const messages = [
            { role: "system", content: fullSystemPrompt },
            ...conversationHistory, 
            { role: "user", content: refinedUserPrompt }
        ];

        try {
            const reply = await engine.chat.completions.create({
                messages: messages,
                temperature: 0.7, // Optimal for Llama 3B Creativity
                max_tokens: 1000, 
                response_format: { type: "json_object" } 
            });

            let rawText = reply.choices[0].message.content;
            console.log(`AI Output (Attempt ${attempt}):`, rawText);

            let cleanText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
            // REMOVE ECHO
            if (cleanText.startsWith(userPrompt)) {
                cleanText = cleanText.substring(userPrompt.length).trim();
            }
            
            let jsonResponse = null;
            try {
                jsonResponse = JSON.parse(cleanText);
            } catch (e) {
                console.warn("JSON Parse Failed. Using Partial Output Scavenger...", e);
            }

            // --- PARTIAL OUTPUT SCAVENGER (Fixes Cut-offs) ---
            if (!jsonResponse) {
                const storyKeyIndex = cleanText.indexOf('"story_text"');
                const optionsKeyIndex = cleanText.indexOf('"options"');
                const themeKeyIndex = cleanText.indexOf('"theme"');

                let extractedStory = "The story continues...";
                
                if (storyKeyIndex !== -1) {
                    let rawStorySegment;
                    if (optionsKeyIndex !== -1 && optionsKeyIndex > storyKeyIndex) {
                        rawStorySegment = cleanText.substring(storyKeyIndex, optionsKeyIndex);
                    } else {
                        rawStorySegment = cleanText.substring(storyKeyIndex);
                    }
                    
                    let cleanSegment = rawStorySegment.replace(/"story_text"\s*:\s*/, "").trim();
                    if (cleanSegment.startsWith('"')) cleanSegment = cleanSegment.substring(1);
                    if (optionsKeyIndex !== -1) {
                        const lastQuote = cleanSegment.lastIndexOf('"');
                        if (lastQuote !== -1) cleanSegment = cleanSegment.substring(0, lastQuote);
                    } else {
                        cleanSegment = cleanSegment.replace(/["},]+$/, ""); 
                    }
                    extractedStory = cleanSegment.replace(/\\"/g, '"');
                }

                let extractedOptions = [];
                if (optionsKeyIndex !== -1) {
                    const openBracket = cleanText.indexOf('[', optionsKeyIndex);
                    const closeBracket = cleanText.indexOf(']', openBracket);
                    if (openBracket !== -1 && closeBracket !== -1) {
                        const rawArray = cleanText.substring(openBracket + 1, closeBracket);
                        extractedOptions = rawArray.split(',').map(s => {
                            return s.trim().replace(/^["']|["']$/g, '');
                        }).filter(s => s.length > 0);
                    }
                }

                let extractedTheme = "modern";
                if (themeKeyIndex !== -1) {
                    const themeSegment = cleanText.substring(themeKeyIndex);
                    const match = themeSegment.match(/"theme"\s*:\s*"([^"]+)"/);
                    if (match) extractedTheme = match[1];
                }

                jsonResponse = {
                    story_text: extractedStory,
                    options: extractedOptions,
                    theme: extractedTheme
                };
            }

            // --- FINAL CLEANUP ---
            if (jsonResponse) {
                if (!jsonResponse.options) jsonResponse.options = [];
                
                if (conversationHistory.length > 0) {
                    const lastMsg = conversationHistory[conversationHistory.length - 1];
                    if (lastMsg.role === "assistant") {
                        try {
                            const lastJson = JSON.parse(lastMsg.content);
                            const prevOptions = lastJson.options || [];
                            jsonResponse.options = jsonResponse.options.filter(opt => !prevOptions.includes(opt));
                        } catch(e) {}
                    }
                }

                if (jsonResponse.options.length > 3) {
                    jsonResponse.options = jsonResponse.options.slice(0, 3);
                }
                const defaults = ["Look around", "Check inventory", "Wait", "Move forward", "Talk", "Inspect"];
                while (jsonResponse.options.length < 3) {
                    const nextDefault = defaults.find(d => !jsonResponse.options.includes(d)) || "Continue";
                    jsonResponse.options.push(nextDefault);
                }
            } else {
                return null;
            }

            conversationHistory.push({ role: "user", content: userPrompt }); 
            conversationHistory.push({ role: "assistant", content: JSON.stringify(jsonResponse) }); 
            if (conversationHistory.length > 6) conversationHistory = conversationHistory.slice(-6);

            return jsonResponse;

        } catch (e) {
            console.error("AI Error:", e);
            if (attempt < 2) {
                 return await getLocalResponse(systemContext, userPrompt, attempt + 1);
            }
            alert("AI Error. Try refreshing the page.");
            return null;
        }
    }

    // --- GAME LOGIC ---

    async function startGame() {
        const input = document.getElementById('start-input').value.trim();
        if (!input) { alert("Enter a scenario!"); return; }

        originalScenario = input;
        
        await initEngine(); 
        toggleLoading(true);

        const system = `
            You are a text adventure engine.
            
            Task:
            1. Write an opening paragraph based on the user's scenario.
            2. Choose a visual theme from ["fantasy", "scifi", "horror", "retro", "modern"].
            3. Provide 3 distinct options for what the user can do next.
            
            Output JSON format:
            { "theme": "...", "story_text": "...", "options": ["...", "...", "..."] }
        `;

        const prompt = `Start the story based on this scenario: "${originalScenario}". Write the opening paragraph and options.`;
        
        const response = await getLocalResponse(system, prompt);
        
        if(response) {
            currentTheme = response.theme || 'modern';
            applyTheme(currentTheme);
            updateUI(response);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
        }
        toggleLoading(false);
    }

    async function handleChoice(choiceText) {
        toggleLoading(true);
        const system = `
            You are narrating the story.
            
            Task:
            1. The user has chosen to: "${choiceText}".
            2. Describe the result of the user's action. Advance the plot.
            3. Provide 3 new options.
            
            Output JSON format:
            { "story_text": "...", "options": ["...", "...", "..."] }
        `;
        
        const response = await getLocalResponse(system, `I choose to: ${choiceText}`);
        if(response) updateUI(response);
        toggleLoading(false);
    }

    async function handleCustomAction(actionText) {
        toggleLoading(true);
        document.getElementById('custom-action-input').value = ""; 
        const system = `
            You are narrating the story.
            
            Task:
            1. The user attempts to: "${actionText}".
            2. Describe the result. Make it happen or explain why it fails.
            3. Provide 3 new options.
            
            Output JSON format:
            { "story_text": "...", "options": ["...", "...", "..."] }
        `;
        
        const response = await getLocalResponse(system, `I attempt to: ${actionText}`);
        if(response) updateUI(response);
        toggleLoading(false);
    }

    async function endGame() {
        toggleLoading(true);
        const system = `
            Scenario: "${originalScenario}".
            
            Task:
            1. Write a DETAILED and SATISFYING narrative conclusion. Do not just say "The End". Wrap up the plot lines.
            2. Explain the final fate of the main character.
            
            Output JSON format:
            { "story_text": "FINAL FATE: [Write your long story ending here...]", "options": [] }
        `;
        
        const response = await getLocalResponse(system, "The user has chosen to end the game. Write the final conclusion now.");
        if(response) {
            document.getElementById('story-display').innerText = response.story_text;
            
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = "<h3>THE END</h3>";
            
            const restartBtn = document.createElement('button');
            restartBtn.innerText = "Start New Game";
            restartBtn.className = "choice-btn"; 
            restartBtn.style.backgroundColor = "#4CAF50"; 
            restartBtn.style.textAlign = "center";
            restartBtn.style.marginTop = "20px";
            restartBtn.onclick = () => window.location.reload();
            choicesContainer.appendChild(restartBtn);

            document.getElementById('controls-section').classList.add('hidden'); 
            localStorage.removeItem('geminiGameSave');
        }
        toggleLoading(false);
    }

    // --- HELPERS ---

    function updateUI(data) {
        currentUIState.story = data.story_text;
        currentUIState.options = data.options;

        const disp = document.getElementById('story-display');
        disp.innerText = data.story_text;
        disp.classList.remove('fade-in');
        void disp.offsetWidth; 
        disp.classList.add('fade-in');

        const cont = document.getElementById('choices-container');
        cont.innerHTML = ""; 
        if (data.options && data.options.length > 0) {
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.className = "choice-btn";
                btn.onclick = () => handleChoice(opt);
                cont.appendChild(btn);
            });
        }
    }

    function applyTheme(themeName) {
        document.body.className = ""; 
        const validThemes = ["fantasy", "scifi", "horror", "retro", "modern"];
        document.body.classList.add(validThemes.includes(themeName) ? `theme-${themeName}` : 'theme-modern');
    }

    function saveGame() {
        localStorage.setItem('geminiGameSave', JSON.stringify({
            originalScenario, conversationHistory, currentTheme, currentUIState
        }));
        const t = document.getElementById('toast');
        t.className = "show";
        setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
    }

    function loadGame() {
        const data = JSON.parse(localStorage.getItem('geminiGameSave'));
        if(!data) return;
        originalScenario = data.originalScenario;
        conversationHistory = data.conversationHistory;
        currentTheme = data.currentTheme;
        currentUIState = data.currentUIState;
        
        applyTheme(currentTheme);
        updateUI({ story_text: currentUIState.story, options: currentUIState.options });
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
    }

    function toggleLoading(isLoading) {
        document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        document.querySelectorAll('button').forEach(b => b.disabled = isLoading);
    }
</script>

</body>
</html>